<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lightweight Paper</title>
  <style>

    :root { --pad: 10px; --gap: 8px; --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; }
    * { box-sizing: border-box; }
    body { font-family: var(--font); margin: 24px; line-height: 1.4; }
    header { display: flex; align-items: center; gap: var(--gap); flex-wrap: wrap; margin-bottom: 16px; }
    h1 { font-size: 22px; margin: 0; }
    .controls { margin-left: auto; display: flex; align-items: center; gap: var(--gap); }
    .tablewrap { overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: var(--pad); border-bottom: 1px solid #eee; white-space: nowrap; }
    th { position: sticky; top: 0; background: #fafafa; text-align: left; cursor: pointer; }
    th.sort-asc::after { content: "↑"; }
    th.sort-desc::after { content: "↓"; }
    caption { text-align: left; padding: 6px 0; font-weight: 600; }
    small.code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f6f8fa; padding: 2px 6px; border-radius: 4px; }
    .note { color: #555; }

  </style>
</head>
<body>
    <h1> {{ title }} </h1>

  {% for collection_name, table_html in tables %}
    <h2>{{ collection_name }}</h2>
    <div class="tablewrap">
      {{ table_html|safe }}
    </div>
  {% endfor %}

<script>
function parseCell(text) {
  const num = Number(text.replace(/,/g, ''));
  return isNaN(num) ? text.toLowerCase() : num;
}

function sortTable(table, colIndex, desc=false) {
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.sort((a, b) => {
    const A = parseCell(a.children[colIndex].innerText);
    const B = parseCell(b.children[colIndex].innerText);
    if (A < B) return desc ? 1 : -1;
    if (A > B) return desc ? -1 : 1;
    return 0;
  });
  rows.forEach(r => tbody.appendChild(r));

  table.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc','sort-desc'));
  const target = table.querySelectorAll('th')[colIndex];
  target.classList.add(desc ? 'sort-desc' : 'sort-asc');
}

function attachSortingAndColoring(table) {
  const headers = table.querySelectorAll('th');
  headers.forEach((th, idx) => {
    let desc = false;
    th.addEventListener('click', () => {
      desc = !desc;
      sortTable(table, idx, desc);
      colorizeNumericColumns(table); // recolor after sorting
    });
  });
  // initial coloring
  colorizeNumericColumns(table);
}

function colorizeNumericColumns(table) {
  const rows = Array.from(table.tBodies[0].rows);
  if (!rows.length) return;

  const numCols = table.rows[0].cells.length;

  for (let col = 0; col < numCols; col++) {
    let values = rows.map(r => Number(r.cells[col].innerText));
    if (values.some(v => isNaN(v))) continue;

    let min = Math.min(...values);
    let max = Math.max(...values);

    rows.forEach(r => {
      let val = Number(r.cells[col].innerText);
      if (isNaN(val)) return;
      let ratio = (val - min) / (max - min + 1e-9); // 0 → 1

      // Simple red→green gradient in HSL
      let hue = 0 + 120 * ratio;   // 0=red, 120=green
      r.cells[col].style.backgroundColor = `hsl(${hue}, 70%, 80%)`;
    });
  }
}


window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('table').forEach(table => {
    attachSortingAndColoring(table);
  });
});
</script>
</body>
</html>
